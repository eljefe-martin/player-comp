var express = require('express');
var sql = require('mssql');
var bodyParser = require('body-parser');
var myData = require('./sampleData.js');

var app = express();
var config = {
    user: 'PlayerProfit',
    password: 'Aliante15',
    server: '192.168.51.176', // You can use 'localhost\\instance' to connect to named instance
    database: 'RWSMKT'
};

//middleware
app.use(express.static('public'));
app.use(bodyParser.json());

//routes
app.get('/api/player/:id', function(req, res) {
	
    var connection =  new sql.Connection(config, function(err) {
     console.log(config);   
        //add some error handling here
        console.log(err);
        var request = new sql.Request(connection);

        request.input('PlayerId', sql.Int, req.params.id);
	request.input('Start', sql.DateTime, req.query.start);
	request.input('End', sql.DateTime, req.query.start);
        request.execute('dbo.asp_PlayerCompLookup_Detail', function(err, recordsets) {
        res.send(recordsets);
        });   

    });
    
    connection.on('error', function(err) {
        console.log("there was an error");
    }); 
    
        
});

app.get('/api/comments/:id', function(req, res) {

     
    var data = [];
    
    myData.commentLog.comments.forEach(function(element, index){
        
        if(element.playerId == req.params.id){
            data.push(element);
        }    
        
    });

    res.send(data);
});   


app.post('/api/post-comment', function(req, res) {

    //stored proc code will go here 
    
    //temporary sample data
    var _json = {
        playerId: req.body.playerId,
        comment: req.body.comment,
        userName: req.body.userName,
        dateId: new Date()
    };
    
    myData.commentLog.comments.push(_json);

    //handle output parm in stored proc
    res.send({commentId:"1uniqeId"});

});   



app.post('/api/login', function(req, res) {

    //need to add body parser to receive the json from the angular call
    
    //varuable to hold return value of procedure
    
    var sessionInfo = {
        userId: req.body.userId,
        accessLevel: 0,
        isUser: false,
        validPassword: false,
    };
    

    myData.loginData.users.forEach(function(element){
        if(element.userId === sessionInfo.userId) {
            //found user check password
            sessionInfo.isUser = true;
            if(element.password === req.body.password){
                //if password matches proceed
                sessionInfo.accessLevel = element.accessLevel;
                sessionInfo.validPassword = true;
            }
        }        
    });
    
    res.send(sessionInfo);
   
});



app.listen(3000, function(){
    console.log("running on port 3000");
});








    

